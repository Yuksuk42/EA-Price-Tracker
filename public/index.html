<!DOCTYPE html>
<html lang="en" class="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EA Play Price Tracker</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        primary: '#FF4747',
                        background: { light: '#F3F4F6', dark: '#0F0F12' },
                        surface: { light: '#FFFFFF', dark: '#18181B', active: { dark: '#27272A' } },
                        text: { main: '#FFFFFF', subtle: '#A1A1AA' }
                    }
                }
            }
        }
    </script>
    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: #0F0F12;
            color: #FFFFFF;
        }

        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #18181B;
        }

        ::-webkit-scrollbar-thumb {
            background: #27272A;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3F3F46;
        }

        @keyframes pulse-warning {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.25);
                color: #facc15;
            }

            100% {
                transform: scale(1);
            }
        }

        .animate-pulse-warning {
            animation: pulse-warning 1.5s infinite ease-in-out;
            will-change: transform;
        }

        @keyframes slide-in {
            0% {
                opacity: 0;
                transform: translateY(10px);
            }

            100% {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes flash-highlight {
            0% {
                background-color: rgba(255, 255, 255, 0.1);
            }

            /* Subtle gray highlight */
            100% {
                background-color: transparent;
            }
        }

        .animate-slide-in {
            animation: slide-in 0.4s ease-out forwards, flash-highlight 1.5s ease-out;
        }

        /* Custom Tooltip */
        #customTooltip {
            position: fixed;
            z-index: 50;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s, transform 0.2s;
            transform: translateY(10px);
        }

        #customTooltip.visible {
            opacity: 1;
            transform: translateY(0);
        }
    </style>
</head>

<body class="bg-background-dark min-h-screen flex flex-col items-center py-12 px-4 sm:px-6 lg:px-8">

    <!-- Custom Tooltip Element -->
    <div id="customTooltip"
        class="bg-black/95 backdrop-blur-xl border border-white/10 text-white text-xs px-4 py-3 rounded-lg shadow-2xl max-w-xs leading-relaxed z-[100]">
        <!-- Content injected via JS -->
    </div>

    <main class="w-full max-w-6xl">
        <!-- Header -->
        <!-- Header -->
        <header class="mb-8 flex justify-between items-end relative">
            <!-- Language Selector -->
            <div
                class="absolute top-0 right-0 flex gap-2 bg-surface-active-dark/50 px-2 py-1 rounded-lg border border-white/5">
                <button onclick="changeLanguage('TR')"
                    class="lang-btn text-[10px] font-bold text-white hover:text-primary transition-colors"
                    data-lang="TR">TR</button>
                <span class="text-[10px] text-white/20">|</span>
                <button onclick="changeLanguage('EN')"
                    class="lang-btn text-[10px] font-bold text-text-subtle hover:text-white transition-colors"
                    data-lang="EN">EN</button>
            </div>

            <div>
                <div class="flex items-center gap-3 mb-2 mt-6">
                    <!-- mt-6 to clear lang selector if needed, or just let it be -->
                    <span class="material-symbols-outlined text-primary text-4xl">sports_esports</span>
                    <span class="bg-primary px-2 py-0.5 rounded text-[10px] font-bold tracking-wider"
                        data-i18n="title_global">GLOBAL</span>
                </div>
                <h1 class="text-4xl font-bold tracking-tight text-white mb-2" data-i18n="title_tracker">EA Play Price
                    Tracker</h1>
                <p class="text-text-subtle text-lg" data-i18n="subtitle">Comparing prices across 89 countries.</p>
                <!-- Rate Warning -->
                <p id="rateWarning" class="hidden text-xs text-yellow-500 mt-2 font-medium flex items-center gap-1">
                    <span class="material-symbols-outlined text-[14px]">warning</span>
                    <span data-i18n="rate_warning">Exchange rates may be outdated. Using fallback (43.00).</span>
                </p>
            </div>
            <div class="hidden md:block text-right">
                <p class="text-[10px] text-text-subtle font-bold tracking-widest uppercase mb-1" id="lowestLabel"
                    data-i18n="lowest_label">LOWEST PRO YEARLY</p>
                <div class="text-3xl font-bold text-primary flex items-center justify-end gap-2">
                    <span id="lowestPrice">--</span>
                </div>
                <p class="text-sm text-text-subtle mt-1" id="lowestCountry">--</p>
            </div>
        </header>

        <!-- Controls -->
        <div
            class="flex flex-col xl:flex-row justify-between items-center gap-4 mb-8 bg-surface-dark p-2 rounded-xl border border-white/5 shadow-lg">

            <!-- Tabs -->
            <div class="flex gap-1 bg-surface-active-dark/50 p-1 rounded-lg w-full xl:w-auto overflow-x-auto">
                <button
                    class="tab-btn whitespace-nowrap px-4 py-2 rounded-md text-sm font-medium text-text-subtle hover:bg-white/5 transition-all"
                    data-name="Basic Monthly" data-tab="basicMonthly">Basic Monthly</button>
                <button
                    class="tab-btn whitespace-nowrap px-4 py-2 rounded-md text-sm font-medium text-text-subtle hover:bg-white/5 transition-all"
                    data-name="Basic Yearly" data-tab="basicYearly">Basic Yearly</button>
                <button
                    class="tab-btn whitespace-nowrap px-4 py-2 rounded-md text-sm font-medium text-text-subtle hover:bg-white/5 transition-all"
                    data-name="Pro Monthly" data-tab="proMonthly">Pro Monthly</button>
                <button
                    class="tab-btn whitespace-nowrap px-4 py-2 rounded-md text-sm font-medium bg-primary text-white shadow-md transition-all"
                    data-name="Pro Yearly" data-tab="proYearly">Pro Yearly</button>
            </div>

            <!-- Handlers (Search, Sort, Refresh) -->
            <div class="flex items-center gap-3 w-full xl:w-auto">
                <!-- Search -->
                <div class="relative w-full xl:w-64">
                    <span
                        class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-text-subtle text-[18px]">search</span>
                    <input type="text" id="searchInput" placeholder="Search country..."
                        class="w-full bg-surface-active-dark/50 border border-white/5 text-white text-sm rounded-lg pl-10 pr-4 py-2 focus:outline-none focus:border-primary/50 transition-colors placeholder-gray-500">
                </div>

                <!-- Sort -->
                <select id="sortSelect"
                    class="bg-surface-active-dark/50 border border-white/5 text-text-subtle text-sm rounded-lg px-3 py-2 focus:outline-none focus:border-primary/50 cursor-pointer hover:text-white transition-colors appearance-none">
                    <option value="priceAsc">Price: Low to High</option>
                    <option value="priceDesc">Price: High to Low</option>
                    <option value="nameAsc">Name: A-Z</option>
                </select>

                <!-- Refresh -->
                <button id="refreshBtn"
                    class="flex items-center gap-2 px-4 py-2 text-sm font-medium text-text-subtle hover:text-white transition-colors whitespace-nowrap">
                    <span class="material-symbols-outlined text-[18px]">refresh</span>
                    <span data-i18n="refresh_btn">Refresh</span>
                </button>
            </div>
        </div>

        <!-- Progress Bar -->
        <div id="statusIndicator"
            class="hidden flex items-center justify-between bg-primary/10 border border-primary/20 text-primary px-4 py-3 rounded-lg mb-6 sticky top-4 backdrop-blur-md z-10 shadow-lg">
            <div class="flex items-center gap-3">
                <span class="relative flex h-3 w-3">
                    <span
                        class="animate-ping absolute inline-flex h-full w-full rounded-full bg-primary opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-3 w-3 bg-primary"></span>
                </span>
                <span class="font-medium tracking-wide" id="statusText">Scanning...</span>
            </div>
            <div class="flex items-center gap-3">
                <span class="text-sm font-bold opacity-80" id="progressText">0%</span>
                <div class="w-24 h-1.5 bg-primary/20 rounded-full overflow-hidden">
                    <div id="progressBar" class="h-full bg-primary transition-all duration-500 ease-out w-0"></div>
                </div>
            </div>
        </div>

        <!-- Table Container -->
        <div
            class="bg-surface-light dark:bg-surface-dark rounded-xl shadow-xl overflow-hidden border border-gray-200 dark:border-white/5 relative">
            <div class="overflow-x-auto">
                <table class="w-full text-left border-collapse">
                    <thead>
                        <tr
                            class="bg-gray-50 dark:bg-white/5 border-b border-gray-200 dark:border-white/5 text-xs uppercase tracking-wider text-gray-500 dark:text-gray-400">
                            <th class="px-6 py-4 font-semibold" data-i18n="th_countries">Countries</th>
                            <th class="px-6 py-4 font-semibold" data-i18n="th_original">Original Price</th>
                            <th class="px-6 py-4 font-semibold" data-i18n="th_your_price">Your Price</th>
                            <th class="px-6 py-4 font-semibold">USD</th>
                        </tr>
                    </thead>
                    <tbody id="priceTableBody"
                        class="divide-y divide-gray-200 dark:divide-white/5 text-sm transition-all duration-300 ease-in-out transform">
                        <!-- Rows will be injected here -->
                    </tbody>
                </table>
            </div>
        </div>
    </main>

    <footer
        class="bg-gray-50 dark:bg-surface-active-dark/20 border-t border-gray-200 dark:border-white/5 py-8 mt-4 w-full">
        <div class="mx-auto max-w-6xl px-6 flex flex-col items-center text-center">
            <p class="text-xs text-text-subtle dark:text-gray-500 max-w-2xl leading-relaxed">
                <strong id="footerLegalTitle">Legal Disclaimer:</strong> <span id="footerLegalText">This website is an
                    educational tool designed for informational purposes only. It is not affiliated with, endorsed by,
                    or connected to Electronic Arts (EA). All trademarks, logos, and brand names are the property of
                    their respective owners. Users appear solely responsible for any decisions made based on this
                    data.</span>
            </p>
            <div class="mt-4 flex gap-4 text-xs font-medium text-text-subtle">
                <span>Â© 2026 EA Price Tracker</span>
                <a href="https://github.com/Yuksuk42/EA-Price-Tracker" target="_blank"
                    class="hover:text-primary">GitHub</a>
            </div>
        </div>
    </footer>

    <script>
        // --- LOCALIZATION & CONSTANTS ---
        const TRANSLATIONS = {
            EN: {
                title_global: "GLOBAL",
                title_tracker: "EA Play Price Tracker",
                subtitle: "Comparing prices across 89 countries where EA Play is sold.",
                lowest_label: "LOWEST",
                refresh_btn: "Refresh",
                th_countries: "COUNTRIES",
                th_original: "ORIGINAL PRICE",
                th_your_price: "YOUR PRICE",
                status_scanning: "Scanning... ",
                status_complete: "Values Updated",
                best_badge: "BEST",
                regions_count: "regions",
                warning_egypt: "Warning: Payment method restrictions may apply (Local cards only).",
                footer_legal: "Legal Disclaimer:",
                footer_text: "This website is an educational tool designed for informational purposes only. It is not affiliated with, endorsed by, or connected to Electronic Arts (EA). All trademarks, logos, and brand names are the property of their respective owners. Users appear solely responsible for any decisions made based on this data.",
                rate_warning: "Live rates unavailable. Using updated fallback rates.",
                search_placeholder: "Search country...",
                sort_price_asc: "Price: Low to High",
                sort_price_desc: "Price: High to Low",
                sort_name_asc: "Name: A-Z",
                tab_basicMonthly: "Basic Monthly",
                tab_basicYearly: "Basic Yearly",
                tab_proMonthly: "Pro Monthly",
                tab_proYearly: "Pro Yearly"
            },
            TR: {
                title_global: "KÃœRESEL",
                title_tracker: "EA Play Fiyat TakipÃ§isi",
                subtitle: "EA Play'in satÄ±ldÄ±ÄŸÄ± 89 Ã¼lkedeki fiyatlar karÅŸÄ±laÅŸtÄ±rÄ±lÄ±yor.",
                lowest_label: "EN UCUZ",
                refresh_btn: "Yenile",
                th_countries: "ÃœLKELER",
                th_original: "ORÄ°JÄ°NAL FÄ°YAT",
                th_your_price: "SÄ°ZÄ°N FÄ°YATINIZ",
                status_scanning: "TaranÄ±yor... ",
                status_complete: "Fiyatlar GÃ¼ncellendi",
                best_badge: "EN Ä°YÄ°",
                regions_count: "bÃ¶lge",
                warning_egypt: "UyarÄ±: Ã–deme yÃ¶ntemi kÄ±sÄ±tlamalarÄ± olabilir (Sadece yerel kartlar).",
                footer_legal: "Yasal UyarÄ±:",
                footer_text: "Bu proje yalnÄ±zca eÄŸitim ve bilgilendirme amaÃ§lÄ±dÄ±r. Electronic Arts (EA) ile hiÃ§bir baÄŸlantÄ±sÄ± yoktur. TÃ¼m markalar ve logolar ilgili sahiplerine aittir. KullanÄ±cÄ±lar, bu verilere dayanarak aldÄ±klarÄ± kararlardan tamamen kendileri sorumludur.",
                rate_warning: "GÃ¼ncel kur Ã§ekilemedi. Son bilinen sabit kurlar kullanÄ±lÄ±yor.",
                search_placeholder: "Ãœlke ara...",
                sort_price_asc: "Fiyat: Artan",
                sort_price_desc: "Fiyat: Azalan",
                sort_name_asc: "Ä°sim: A-Z",
                tab_basicMonthly: "Basic AylÄ±k",
                tab_basicYearly: "Basic YÄ±llÄ±k",
                tab_proMonthly: "Pro AylÄ±k",
                tab_proYearly: "Pro YÄ±llÄ±k"
            }
        };

        // Add to DOM Elements
        const searchInput = document.getElementById('searchInput');
        const sortSelect = document.getElementById('sortSelect');

        // LISTENERS
        if (searchInput) {
            searchInput.addEventListener('input', (e) => {
                searchTerm = e.target.value;
                renderTable();
            });
        }
        if (sortSelect) {
            sortSelect.addEventListener('change', (e) => {
                sortOrder = e.target.value;
                renderTable();
            });
        }

        // DEFAULT TO TURKEY / 43
        let userLang = 'TR';
        let userCurrency = 'TRY';
        let conversionRate = 43.0;

        // --- DOM ELEMENTS ---
        const tbody = document.getElementById('priceTableBody');
        const tabs = document.querySelectorAll('.tab-btn');
        const refreshBtn = document.getElementById('refreshBtn');
        const refreshIcon = refreshBtn.querySelector('.material-symbols-outlined');
        const statusIndicator = document.getElementById('statusIndicator');
        const progressBar = document.getElementById('progressBar');
        const progressText = document.getElementById('progressText');
        const statusText = document.getElementById('statusText');
        const lowestPriceEl = document.getElementById('lowestPrice');
        const lowestCountryEl = document.getElementById('lowestCountry');
        const lowestLabelEl = document.getElementById('lowestLabel');
        const tooltipEl = document.getElementById('customTooltip');
        const rateWarningEl = document.getElementById('rateWarning');

        let currentData = [];
        let activeTab = 'proYearly';
        let activeTabName = 'Pro Yearly';
        let isScanning = false;
        let scanInterval;
        let regionNames = new Intl.DisplayNames(['tr'], { type: 'region' });

        // FILTER & SORT STATE
        let searchTerm = '';
        let sortOrder = 'priceAsc';

        function detectLanguage(countryCode) {
            if (countryCode === 'TR') return 'TR';
            return 'EN';
        }

        function changeLanguage(lang) {
            userLang = lang;
            applyLocalization();
            renderTable();
            updateLowestPrice();
        }

        function applyLocalization() {
            const t = TRANSLATIONS[userLang] || TRANSLATIONS.EN;

            // Updated Language Buttons UI
            document.querySelectorAll('.lang-btn').forEach(btn => {
                const btnLang = btn.getAttribute('data-lang');
                if (btnLang === userLang) {
                    btn.classList.remove('text-text-subtle', 'hover:text-white');
                    btn.classList.add('text-white', 'hover:text-primary');
                    btn.style.opacity = '1';
                    btn.style.textDecoration = 'underline';
                } else {
                    btn.classList.remove('text-white', 'hover:text-primary');
                    btn.classList.add('text-text-subtle', 'hover:text-white');
                    btn.style.opacity = '0.5';
                    btn.style.textDecoration = 'none';
                }
            });

            // Update Region Names Locale
            const localeCode = userLang === 'TR' ? 'tr' : 'en';
            regionNames = new Intl.DisplayNames([localeCode], { type: 'region' });

            // 1. Simple Text Replacements
            const safeSet = (sel, key) => {
                const el = document.querySelector(sel);
                if (el && t[key]) el.textContent = t[key];
            };

            safeSet('[data-i18n="title_global"]', 'title_global');
            safeSet('[data-i18n="title_tracker"]', 'title_tracker');
            safeSet('[data-i18n="subtitle"]', 'subtitle');
            safeSet('[data-i18n="rate_warning"]', 'rate_warning');
            safeSet('#footerLegalTitle', 'footer_legal');
            safeSet('#footerLegalText', 'footer_text');

            // 2. Table Headers
            document.querySelectorAll('[data-i18n]').forEach(el => {
                const key = el.getAttribute('data-i18n');
                if (key.startsWith('th_') && t[key]) {
                    el.textContent = t[key];
                }
            });

            // 3. Inputs & Selects
            if (searchInput && t.search_placeholder) {
                searchInput.placeholder = t.search_placeholder;
            }
            if (sortSelect) {
                if (t.sort_price_asc) sortSelect.options[0].text = t.sort_price_asc;
                if (t.sort_price_desc) sortSelect.options[1].text = t.sort_price_desc;
                if (t.sort_name_asc) sortSelect.options[2].text = t.sort_name_asc;
            }

            // 4. Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                const key = 'tab_' + btn.dataset.tab;
                if (t[key]) btn.textContent = t[key];
            });

            // 5. Refresh Button (Icon + Text mixed)
            // Use querySelector to find the span inside
            const refreshTextSpan = document.querySelector('#refreshBtn span[data-i18n="refresh_btn"]');
            if (refreshTextSpan && t.refresh_btn) {
                refreshTextSpan.textContent = t.refresh_btn;
            }

            updateHeaderLabel();
        }

        async function init() {
            try {
                // DEBUG MODE: SIMULATE GERMANY (Enable if true)
                const DEBUG_MODE = false;

                if (DEBUG_MODE) {
                    console.log("ðŸ› ï¸ DEBUG MODE ACTIVE: Simulating GERMANY/EUR");
                    userCurrency = 'EUR';
                    // Force English to verify translation
                    userLang = 'EN';
                    conversionRate = 0.95;
                } else {
                    // DEFAULT IS ALREADY SET TO TR / 43.0 ABOVE.

                    try {
                        const locRes = await fetch('https://ipapi.co/json/');
                        if (locRes.ok) {
                            const locData = await locRes.json();
                            const detectedCurrency = locData.currency || 'USD';
                            const countryCode = locData.country_code || 'US';

                            userCurrency = detectedCurrency;
                            userLang = detectLanguage(countryCode);

                            // Reset rate if NOT TRY (because default is 43)
                            if (userCurrency !== 'TRY') {
                                conversionRate = 1; // Temporary USD default before fetch
                            }
                        }
                    } catch (e) { console.log("IPAPI failed, keeping defaults (TR/43)"); }
                }

                // Rate Fetch Logic
                let rateFetched = false;
                if (userCurrency !== 'USD') {
                    try {
                        const rateRes = await fetch(`https://open.er-api.com/v6/latest/USD`);
                        if (rateRes.ok) {
                            const rateData = await rateRes.json();
                            if (rateData.rates[userCurrency]) {
                                conversionRate = rateData.rates[userCurrency];
                                rateFetched = true;
                            }
                        }
                    } catch (e) { console.log("Rate fetch failed"); }
                }

                // If Rate Fetch FAILED and we are falling back
                if (!rateFetched && userCurrency === 'TRY') {
                    // We are using hardcoded 43
                    rateWarningEl.classList.remove('hidden');
                } else if (!rateFetched && userCurrency !== 'USD' && userCurrency !== 'TRY') {
                    // We failed to get rate for a foreign currency... catastrophic failure?
                    // No, usually default is TR/43, but if IPAPI said "EUR" and OpenER failed,
                    // we are stuck with conversionRate = 1 (set above).
                    // In this case, warn user.
                    rateWarningEl.classList.remove('hidden');
                }

                console.log(`Initialized: Lang=${userLang}, Currency=${userCurrency}, Rate=${conversionRate}`);

                applyLocalization();

                // Update header with precise currency
                const t = TRANSLATIONS[userLang] || TRANSLATIONS.EN;
                const yourPriceTh = document.querySelector('[data-i18n="th_your_price"]');
                if (yourPriceTh) yourPriceTh.textContent = `${t.th_your_price} (${userCurrency})`;

                startPolling();

            } catch (e) {
                console.error("Init CRITICAL failure:", e);
                startPolling();
            }
        }

        function startPolling() {
            fetchData();
            scanInterval = setInterval(fetchData, 1000);
        }

        async function triggerRefresh() {
            if (isScanning) return;

            tbody.classList.add('opacity-0', 'blur-sm', 'translate-y-2');

            refreshBtn.disabled = true;
            refreshBtn.classList.add('opacity-50', 'cursor-not-allowed');
            refreshIcon.classList.add('animate-spin');

            setTimeout(async () => {
                tbody.innerHTML = '';
                tbody.classList.remove('opacity-0', 'blur-sm', 'translate-y-2');

                currentData = [];
                updateLowestPrice();

                statusIndicator.classList.remove('hidden');
                statusIndicator.classList.add('flex');
                rateWarningEl.classList.add('hidden');

                try {
                    await fetch('/api/refresh');
                    isScanning = true;
                } catch (e) {
                    console.error("Refresh trigger failed", e);
                    isScanning = false;
                    stopRefreshUI();
                }
            }, 300);
        }

        function stopRefreshUI() {
            refreshBtn.disabled = false;
            refreshBtn.classList.remove('opacity-50', 'cursor-not-allowed');
            refreshIcon.classList.remove('animate-spin');

            setTimeout(() => {
                statusIndicator.classList.add('hidden');
                statusIndicator.classList.remove('flex');
            }, 2000);
        }

        async function fetchData() {
            try {
                const res = await fetch('/api/prices');
                const data = await res.json();

                // FLICKER FIX: Check if data length changed or completion changed BEFORE rendering
                // We use currentData for rendering. checking deep equality is expensive.
                // Just checking length and last element is usually enough for a "stream".
                const prevLen = currentData.length;
                const newLen = data.successful.length;

                // Update internal state
                currentData = data.successful;
                const completed = data.completed;
                const total = data.total;
                const isServerScanning = data.isScanning;

                // Sync Scanning State
                if (isServerScanning && !isScanning) {
                    isScanning = true;
                    refreshBtn.disabled = true;
                    refreshIcon.classList.add('animate-spin');
                    statusIndicator.classList.remove('hidden');
                    statusIndicator.classList.add('flex');
                } else if (isScanning && !isServerScanning && completed >= total) {
                    isScanning = false;
                    stopRefreshUI();
                    const t = TRANSLATIONS[userLang] || TRANSLATIONS.EN;
                    statusText.textContent = t.status_complete;
                }

                if (isScanning) {
                    const percent = Math.round((completed / total) * 100);
                    progressBar.style.width = `${percent}%`;
                    progressText.textContent = `${percent}%`;
                    const t = TRANSLATIONS[userLang] || TRANSLATIONS.EN;
                    statusText.textContent = `${t.status_scanning} (${completed}/${total})`;
                }

                // ONLY RENDER IF DATA CHANGED OR IF IT'S INITIAL LOAD
                if (newLen !== prevLen || prevLen === 0 || searchTerm !== '') {
                    renderTable();
                    updateLowestPrice();
                } else {
                    // Even if length is same, check if last item is different (maybe same length but replaced?)
                    // For this app, it usually just appends.
                    // But we should update lowest price just in case.
                    // The "Flashing" hover happens because we wipe innerHTML.
                    // If we skipped renderTable, the hover stays intact.
                }

            } catch (e) {
                console.error("Fetch error:", e);
            }
        }

        function convert(usdPrice) {
            if (usdPrice === undefined || usdPrice === null) return '-';
            return Math.round(usdPrice * conversionRate).toLocaleString();
        }

        // TOOLTIP LOGIC
        function showTooltip(e, text) {
            tooltipEl.textContent = text;
            tooltipEl.classList.add('visible');
            moveTooltip(e);
        }
        function hideTooltip() {
            tooltipEl.classList.remove('visible');
        }
        function moveTooltip(e) {
            tooltipEl.style.left = `${e.clientX + 15}px`;
            tooltipEl.style.top = `${e.clientY + 15}px`;
        }
        document.addEventListener('mousemove', (e) => {
            if (tooltipEl.classList.contains('visible')) moveTooltip(e);
        });

        // RENDER
        function renderTable() {
            // 1. FILTER & PREPARE
            let validItems = currentData
                .filter(item => item[activeTab])
                .map(item => {
                    let displayName = item.name;
                    // Try dynamic translation
                    try { if (item.code) displayName = regionNames.of(item.code.toUpperCase()); } catch (e) { }

                    return {
                        country: item,
                        price: item[activeTab],
                        displayName: displayName,
                        usdVal: item[activeTab].usdVal
                    };
                });

            // 2. SEARCH
            if (searchTerm) {
                const lower = searchTerm.toLocaleLowerCase(userLang === 'TR' ? 'tr' : 'en');
                validItems = validItems.filter(i => i.displayName.toLocaleLowerCase(userLang === 'TR' ? 'tr' : 'en').includes(lower));
            }

            // 3. SORT
            validItems.sort((a, b) => {
                if (sortOrder === 'priceAsc') return a.usdVal - b.usdVal;
                if (sortOrder === 'priceDesc') return b.usdVal - a.usdVal;
                if (sortOrder === 'nameAsc') return a.displayName.localeCompare(b.displayName, userLang === 'TR' ? 'tr' : 'en');
                return 0;
            });

            // 4. GROUPING
            const groups = [];
            validItems.forEach(item => {
                const lastGroup = groups[groups.length - 1];
                // Strict grouping only on Price Sort
                const isPriceSort = (sortOrder === 'priceAsc' || sortOrder === 'priceDesc');

                if (lastGroup && isPriceSort && Math.abs(lastGroup.price.usdVal - item.usdVal) < 0.1) {
                    lastGroup.countries.push(item);
                } else {
                    groups.push({
                        price: item.price,
                        countries: [item],
                        id: item.country.code // Simple ID
                    });
                }
            });

            // 5. RENDER
            const existingRows = Array.from(tbody.children);
            const fragment = document.createDocumentFragment();

            groups.forEach((group, index) => {
                const isLowest = (index === 0 && sortOrder === 'priceAsc' && !searchTerm);

                // Construct ID (if grouping, use first country code + price)
                const groupId = group.price.usdVal.toFixed(2) + '_' + group.countries[0].country.code;

                let tr = existingRows.find(row => row.getAttribute('data-price-id') === groupId);
                let isNew = false;
                const staggerDelay = (index * 0.03) + 's';

                if (!tr) {
                    tr = document.createElement('tr');
                    tr.setAttribute('data-price-id', groupId);
                    tr.classList.add('animate-slide-in');
                    tr.style.animationDelay = staggerDelay;
                    isNew = true;
                }

                const baseClass = isLowest
                    ? "bg-primary/5 hover:bg-primary/10 transition-colors"
                    : "hover:bg-gray-50 dark:hover:bg-surface-active-dark transition-colors";

                tr.className = baseClass + (isNew ? " animate-slide-in" : "");

                // Content
                let localPrice;
                if (group.price.originalCurrency === userCurrency) {
                    localPrice = group.price.originalAmount.toLocaleString();
                } else {
                    localPrice = convert(group.price.usdVal);
                }

                const t = TRANSLATIONS[userLang] || TRANSLATIONS.EN;

                const countriesHtml = group.countries.map(obj => {
                    const c = obj.country;
                    const dName = obj.displayName;
                    const isEgypt = c.code === 'eg';
                    const warningHtml = isEgypt ? `<span class="material-symbols-outlined text-yellow-500 text-[18px] cursor-help animate-pulse-warning ml-1" onmouseenter="showTooltip(event, '${t.warning_egypt}')" onmouseleave="hideTooltip()">warning</span>` : '';

                    return `
                    <div class="flex items-center gap-2 mb-1 mr-4">
                        <img src="https://flagcdn.com/24x18/${c.code}.png" class="rounded-sm shadow-sm opacity-80" alt="${dName}">
                        <span class="${isLowest ? 'font-bold' : ''}">${dName}</span>
                        ${warningHtml}
                    </div>`
                }).join('');

                tr.innerHTML = `
                    <td class="px-6 py-4">
                        <div class="flex flex-wrap items-center">
                            ${countriesHtml}
                            ${group.countries.length > 1 ? `<span class="text-xs text-gray-400 ml-1">(${group.countries.length} ${t.regions_count})</span>` : ''}
                            ${isLowest ? `<span class="ml-2 text-[10px] font-bold text-primary uppercase tracking-wide border border-primary/30 px-1 rounded">${t.best_badge}</span>` : ''}
                        </div>
                    </td>
                    <td class="whitespace-nowrap px-6 py-4 text-gray-500">${group.price.originalAmount} ${group.price.originalCurrency}</td>
                    <td class="whitespace-nowrap px-6 py-4 font-medium ${isLowest ? 'text-primary text-lg' : ''}">${localPrice} ${userCurrency}</td>
                    <td class="whitespace-nowrap px-6 py-4 text-gray-400">$${group.price.usd}</td>
                `;

                fragment.appendChild(tr);
            });

            tbody.innerHTML = '';
            tbody.appendChild(fragment);
        }
        function updateHeaderLabel() {
            const t = TRANSLATIONS[userLang] || TRANSLATIONS.EN;
            // Get translated tab name
            const tabKey = 'tab_' + activeTab;
            const translatedTabName = t[tabKey] || activeTabName;

            lowestLabelEl.textContent = `${t.lowest_label} ${translatedTabName.toUpperCase()}`;
        }

        function updateLowestPrice() {
            updateHeaderLabel();

            if (currentData.length === 0) {
                lowestPriceEl.textContent = '--';
                lowestCountryEl.textContent = '--';
                return;
            }
            const valid = currentData.filter(i => i[activeTab]);
            if (valid.length === 0) {
                lowestPriceEl.textContent = '--';
                lowestCountryEl.textContent = '--';
                return;
            }

            valid.sort((a, b) => a[activeTab].usdVal - b[activeTab].usdVal);
            const best = valid[0];
            const bestPrice = best[activeTab];

            if (bestPrice.originalCurrency === userCurrency) {
                lowestPriceEl.textContent = `${bestPrice.originalAmount.toLocaleString()} ${userCurrency}`;
            } else {
                lowestPriceEl.textContent = `${convert(bestPrice.usdVal)} ${userCurrency}`;
            }

            // Should also translate the best country name here
            let bestName = best.name;
            try {
                if (best.code) bestName = regionNames.of(best.code.toUpperCase());
            } catch (e) { }
            lowestCountryEl.textContent = bestName;
        }

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                if (activeTab === tab.getAttribute('data-tab')) return;

                // Visual Feedback on Tabs Immediately
                tabs.forEach(t => {
                    t.classList.remove('bg-primary', 'text-white', 'shadow-md');
                    t.classList.add('text-text-subtle', 'hover:bg-gray-100', 'dark:hover:bg-white/5');
                });
                tab.classList.add('bg-primary', 'text-white', 'shadow-md');
                tab.classList.remove('text-text-subtle', 'hover:bg-gray-100', 'dark:hover:bg-white/5');

                // 1. Fade Out
                tbody.classList.add('opacity-0', 'blur-sm', 'translate-y-2');

                // 2. Wait for transition
                setTimeout(() => {
                    activeTab = tab.getAttribute('data-tab');
                    activeTabName = tab.getAttribute('data-name');

                    renderTable();
                    updateLowestPrice();

                    // 3. Fade In
                    tbody.classList.remove('opacity-0', 'blur-sm', 'translate-y-2');
                }, 300);
            });
        });

        refreshBtn.addEventListener('click', triggerRefresh);

        init();
    </script>
</body>

</html>